#!/bin/bash

ENV=${1:-staging}
COMMIT=$(git rev-parse --short HEAD)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
IMAGE_NAME="586715926679.dkr.ecr.us-east-2.amazonaws.com/sweetspot:${COMMIT}"

exit_on_failure() {
  if [ $? -ne 0 ]; then
    exit 1
  fi
}

if [ ${CURRENT_BRANCH} != "master" ]; then
  echo "You're on ${CURRENT_BRANCH}, deploy from master"
  exit 1
fi

if ! git diff-index --quiet origin/master; then
  echo "Stash or, commit and push your changes, before deploying"
  exit 1
fi

echo "[note] Deployment parameters are:"
echo "| env: ${ENV}"
echo "--"

echo "=> Deploying SweetSpot to ${ENV}"

# Injectable
echo "=> Building injectables"
cd injps/
./script/build $ENV
exit_on_failure
cd ..
echo "=> Finished building injectables"

# API
echo "=> Building image"
docker build --tag sweetspot .
exit_on_failure
echo "=> Finished building image"

# Push to Amazon Container Registry
echo "=> Pushing image to registry"
ECR_LOGIN_CMD=$(aws ecr get-login --no-include-email)
eval $ECR_LOGIN_CMD
docker tag sweetspot $IMAGE_NAME
docker push $IMAGE_NAME
exit_on_failure

# Update sweetspot deployment to latest image
echo "=> Applying new image"
ecs deploy default sweetspot-${ENV} --tag ${COMMIT}
exit_on_failure
echo "=> Done!"
