#!/bin/bash

ENV=${1:-staging}
CLUSTER=$(kubectl config current-context)
DATE=$(date -u "+%F")
COMMIT=$(git rev-parse --short HEAD)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
IMAGE_NAME="gcr.io/supple/supple:${DATE}-${COMMIT}"

exit_on_failure() {
  if [ $? -ne 0 ]; then
    exit 1
  fi
}

if [ ${CURRENT_BRANCH} != "master" ]; then
  echo "You're on ${CURRENT_BRANCH}, deploy from master"
  exit 1
fi

if ! git diff-index --quiet origin/master; then
  echo "Stash or, commit and push your changes, before deploying"
  exit 1
fi

echo "[note] Deployment parameters are:"
echo "| kubectl context: ${CLUSTER}"
echo "| env: ${ENV}"
echo "--"

echo "=> Deploying Supple to ${ENV}"

# Injectable
echo "=> Building injectables"
cd injps/
./script/build
exit_on_failure
cd ..
echo "=> Finished building injectables"

# API
echo "=> Building image"
docker build --quiet --tag supple .
exit_on_failure
echo "=> Finished building image"

# Push to Google Container Registry
echo "=> Pushing image to registry"
docker tag supple $IMAGE_NAME
docker push $IMAGE_NAME
exit_on_failure

# Update supple deployment to latest image
echo "=> Applying new image"
kubectl set image deploy/supple supple=$IMAGE_NAME
exit_on_failure
echo "=> Watching supple deployment for the next 30s"
timeout --preserve-status --signal INT 30s kubectl get --watch deployments supple; exit 0
echo "=> Done!"
